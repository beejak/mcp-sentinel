"""
Vulnerability model representing security findings.
"""

from enum import Enum
from typing import Optional, Dict, Any, List
from datetime import datetime
from pydantic import BaseModel, Field


class Severity(str, Enum):
    """Vulnerability severity levels."""

    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"

    def score(self) -> int:
        """Return numeric score for severity (0-100)."""
        scores = {
            Severity.CRITICAL: 90,
            Severity.HIGH: 70,
            Severity.MEDIUM: 50,
            Severity.LOW: 30,
            Severity.INFO: 10,
        }
        return scores[self]


class Confidence(str, Enum):
    """Confidence level of the finding."""

    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"


class VulnerabilityType(str, Enum):
    """Types of vulnerabilities detected."""

    SECRET_EXPOSURE = "secret_exposure"
    CODE_INJECTION = "code_injection"
    PROMPT_INJECTION = "prompt_injection"
    TOOL_POISONING = "tool_poisoning"
    SUPPLY_CHAIN = "supply_chain"
    CONFIG_SECURITY = "config_security"
    XSS = "xss"
    PATH_TRAVERSAL = "path_traversal"
    WEAK_CRYPTO = "weak_crypto"
    INSECURE_DESERIALIZATION = "insecure_deserialization"


class Vulnerability(BaseModel):
    """
    Represents a security vulnerability finding.

    Attributes:
        id: Unique identifier
        type: Vulnerability type
        title: Short description
        description: Detailed description
        severity: Severity level
        confidence: Confidence in the finding
        file_path: Path to affected file
        line_number: Line number where vulnerability was found
        line_end: End line number (for multi-line findings)
        code_snippet: Relevant code snippet
        cwe_id: Common Weakness Enumeration ID
        cvss_score: CVSS score (if applicable)
        remediation: Suggested fix
        references: Additional reference links
        metadata: Additional metadata
        detector: Name of detector that found this
        engine: Analysis engine that detected it
        timestamp: When the vulnerability was detected
    """

    id: str = Field(default_factory=lambda: f"vuln-{datetime.utcnow().timestamp()}")
    type: VulnerabilityType
    title: str
    description: str
    severity: Severity
    confidence: Confidence = Confidence.MEDIUM

    # Location
    file_path: str
    line_number: int
    line_end: Optional[int] = None
    code_snippet: Optional[str] = None

    # Classification
    cwe_id: Optional[str] = None
    cvss_score: Optional[float] = None

    # Remediation
    remediation: Optional[str] = None
    references: List[str] = Field(default_factory=list)

    # Metadata
    metadata: Dict[str, Any] = Field(default_factory=dict)
    detector: str
    engine: str
    timestamp: datetime = Field(default_factory=datetime.utcnow)

    # Threat intelligence
    mitre_attack_ids: List[str] = Field(default_factory=list)
    threat_intel: Optional[Dict[str, Any]] = None

    class Config:
        json_schema_extra = {
            "example": {
                "id": "vuln-1234567890",
                "type": "secret_exposure",
                "title": "Hardcoded AWS Access Key",
                "description": "AWS access key found hardcoded in source code",
                "severity": "critical",
                "confidence": "high",
                "file_path": "src/config.py",
                "line_number": 42,
                "code_snippet": 'AWS_ACCESS_KEY = "AKIA..."',
                "cwe_id": "CWE-798",
                "cvss_score": 9.1,
                "remediation": "Move credentials to environment variables or secret manager",
                "references": [
                    "https://cwe.mitre.org/data/definitions/798.html"
                ],
                "detector": "SecretsDetector",
                "engine": "static",
                "mitre_attack_ids": ["T1552.001"]
            }
        }

    def to_sarif(self) -> Dict[str, Any]:
        """Convert to SARIF format."""
        return {
            "ruleId": self.cwe_id or self.type.value,
            "level": self._sarif_level(),
            "message": {
                "text": self.description
            },
            "locations": [{
                "physicalLocation": {
                    "artifactLocation": {
                        "uri": self.file_path
                    },
                    "region": {
                        "startLine": self.line_number,
                        "endLine": self.line_end or self.line_number,
                        "snippet": {
                            "text": self.code_snippet or ""
                        }
                    }
                }
            }]
        }

    def _sarif_level(self) -> str:
        """Map severity to SARIF level."""
        mapping = {
            Severity.CRITICAL: "error",
            Severity.HIGH: "error",
            Severity.MEDIUM: "warning",
            Severity.LOW: "note",
            Severity.INFO: "note",
        }
        return mapping[self.severity]

    def risk_score(self) -> float:
        """
        Calculate risk score (0-100) based on severity and confidence.

        Returns:
            Float between 0 and 100
        """
        severity_weight = self.severity.score()

        confidence_multiplier = {
            Confidence.HIGH: 1.0,
            Confidence.MEDIUM: 0.8,
            Confidence.LOW: 0.6,
        }

        return severity_weight * confidence_multiplier[self.confidence]
